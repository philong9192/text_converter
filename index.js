'use strict';

import xlsx from 'node-xlsx';
import path, { join } from "path";
import fs from 'fs';

const __dirname = path.resolve();
const fs2 = fs.promises;

const TYPE = {
	FIX_SO_DIEN_THOAI: 0,
	FIX_KHONG_NHAY_DONG: 1,
}

/* ---------------------- NHAP DU LIEU TU DAY ---------------------- */

const __DATA = `
st:975117312
st:975117312
St0355505402
O899466437
O889465744
O886250850
O879366678
O869796820
O869784382
O868355634
O868234280
O867951694
O866195912
O866181472
O866176186
O857144016
O855939322
O852116790
O845966221
O838354612
O837775071
O836208013
O833233262
O832681233
O818887374
O818887374
O817998833
O386464258
O356387350
O356387350
988454979
987841008
987126465
986167103‬
984711440
984002103
983568***
979650520
979650520
979423760
979423760
975933834or03
975484***
971400234
969835215và09
969691222(3282
969691222(3282
968414***
968280***
967261573
966896***
966896***
966640259
966414287và03
966414287và03
963059423
944986679
942338965
93819438490644
938070***
935772020
934206263
933110098
93211367184790
919334982
91682369277417
914242007
914095***
91386860893265
913439844
912807970
90822954693339
904170748
902794***
901752015
878619355(8786
866790811
852081720
839257501
836753675
836095669
832782789
798772075
797566639
777934274
777934274
776428316
584647727
523455878
399018965
392567454
389502855
388859159917
388247017
384824317
382302464
372193728
367248***
366962423
356752148
354564283
346389875
346337626
345041696
336870478
335313667
335313667
0989889873
0986618***
0986584680‬
098626718708
0985802592
0983018060
0982980545or0
0982776388
0985356599
097966646909
0978246187034
0977254001
0977254001
09765625650398
0976558614
0975244356
0973826100
097356863803
09733982140919
0973131728
0973371370
0972263973038
0972263674096
0971667695
097161719009
0968846064or0
0968085354
0967034556
0966944391
0966733868
0964301496
0964039***
0963641002h0ặc
0963597669098
0963597669098
0962872846
096284554809
0962123386079
0949550557
0945524***
0944149459
094389281808
09433310580943
094307212309
094307212309
09425196390983
09397359128912
0939580602
0939580602
0937475526(03
0936964997Hoặc
0935163***
0934606596
093414469609
0932837778070
0925510575
0919868345
09187662490982
09182383200353
0918238320035
0918100626
0918012902
091768550703
0916036412Hoặc
0915824386và0
0915824386và0
0913927819or0
0913092005
0912921656
0911866107
0913990171
09092725750774
0908866642D14:D
0906801***
0906739900
0905162525
0904327791sốn
0904168612094
090273476576
090273476576
0906320678
0903999354
08990833090989
0869952094
0858518166
0857236500
08541556660986
08541556660986
08541556660986
08541556660986
08541556660986
08541556660986
08541556660986
08541556660986
08530129270945
0852374589
0835746888
0835561747
0829007792
08227132310395
0818279812
08170693970
0795441794
0795441794
0795441794
0792818105///
0795627871
07866963460388
07781389250369
0777770987(09
0776787675
0773093759
0772331948
0769967369(con
0763063051
0398078332và0
0394056847or0
0392396838
0389751393or0
0387601642
0387334308(09
0386779360(03
03784297413878
0378396024(09
0378353401076
0378353401076
0378353401076
0378353401076
0378353401076
0377715757
0376677821
0376045429or0
0375257414
0375257414
0375257414
0373396806
037222807907
0378062241
0369337037H0ẶC
0368801405086
0368382440
0368224610
0368223312or0
0366438173
0366397***
0365364074039
0364717813037
0364190127(03
036298396809
036298396809
0362541962
0362391061
0359603147vs0
03552880900911
0354666467
0354456467(03
0352775590)
0352164***
0352164***
0359347439
0342643001or0
0342528639
03424541763773
0347171336
0339272504
0339272504
0338828546037
0338771088or0
033758163408
0336040619và0
0334834088
0334746161or0
0334388***
0334383***
032698588203
0326937875
0347266388
0963126063
0345429655
‘0977400419
‘0973343055
‘0969369732
‘0969369732
‘0843288768
‘0387305794
‘0384667256
‘0353302767
‘0353302767
‘0353302767
‘0353302767
‘0353302767
‘0353302767
‘0355647054
‘0349223364
‘0343861466
‘0336728267
‘0333958803
‘0333398715
0978262450
​0935405079
0902282652
968958E+13
968535E+13
368997E+13
367203E+13
366403E+13
349073E+13
209445E+13
117204E+13
941467E+12
917327E+12
597034E+12
334126E+12
985152E+11
973996E+11
919457E+11
91442E+11
908559E+11
02438E+11
819322E+11
395729E+11
384548E+11
375555E+11
368658E+11
36844E+11
360339E+11
333225E+11
280939E+11
280332E+11
260373E+11
260373E+11
220965E+11
220949E+11
220383E+11
210979E+11
210962E+11
`

const type = TYPE.FIX_SO_DIEN_THOAI
// const type = TYPE.FIX_KHONG_NHAY_DONG


/* ------------------------------------------------------------------ */

const onExportFile = async (arrText) => {

	const options = {'!cols': [{ wch: 15 }, { wch: 30 }, { wch: 40 }, { wch: 10 }, { wch: 15 } ]};

	let buffer = xlsx.build([{name: "sheet1", data: arrText}], options); // Returns a buffer

	const pathFile = path.join(__dirname, 'files', 'exported_data.xlsx');

	try {
		await fs2.writeFile(pathFile, buffer);
	} catch (err) {
		return console.log(err);
	}

    console.log("Xuất file thành công!!!");
}

const fixSoDienThoai = (text) => {

	let dataFixed = "";
	
	dataFixed = text.replace(/đ/g, "");
	dataFixed = text.replace(/st:/g, "");
	dataFixed = dataFixed.replace(/\./g, "");
	dataFixed = dataFixed.replace(/\,/g, "");
	dataFixed = dataFixed.replace(/ /g, "");
	dataFixed = dataFixed.replace(/-/g, "");
	// dataFixed = dataFixed.replace(/hoặc/g, "");
	dataFixed = dataFixed.replace(/St/g, "");
	dataFixed = dataFixed.replace(/\*/g, "");

	if (dataFixed.startsWith('\`')) {
		dataFixed = dataFixed.replace('\`', "");
	}

	if (dataFixed.startsWith('\'')) {
		dataFixed = dataFixed.replace("\'", "");
	}

	if (dataFixed.startsWith('0:')) {
		dataFixed = dataFixed.replace("0:", "");
	}

	const arrDataFixed = dataFixed.split('/');

	if (arrDataFixed.length == 2) {
		dataFixed = arrDataFixed[0];
	}

	const arrDataFixed1 = dataFixed.split('or');

	if (arrDataFixed1.length == 2) {
		dataFixed = arrDataFixed1[0];
	}

	const arrDataFixed2 = dataFixed.split('và');

	if (arrDataFixed2.length == 2) {
		dataFixed = arrDataFixed2[0];
	}

	const arrDataFixed3 = dataFixed.split('(');

	if (arrDataFixed3.length == 2) {
		dataFixed = arrDataFixed3[0];
	}

	if (dataFixed.startsWith('84')) {
		dataFixed = dataFixed.replace("84", "0");
	}
	
	if (dataFixed.startsWith('O')) {
		dataFixed = dataFixed.replace("O", "0");
	}

	dataFixed = dataFixed.replace(/\//g, "");
	dataFixed = dataFixed.replace(/\‘/g, "");

	//END add 0
	if (dataFixed.startsWith('9') || dataFixed.startsWith('8') || dataFixed.startsWith('7') || dataFixed.startsWith('3')) {
		dataFixed = "0" + dataFixed
	}

	// console.log(dataFixed);

	return dataFixed;
}

const fixKhongNhayDong = () => {
	let arrText = __DATA.split('\n');
	// console.log(arrText.length);

	let data = [];

	for (const text of arrText) {
		data.push([text]);
	}

	onExportFile(data);
}

const onStartFixPhoneNumber = () => {

	let data = [];

	const arrText = __DATA.split('\n');

	for (const text of arrText) {
		const _text = fixSoDienThoai(text);
		data.push([_text]);
	}

	onExportFile(data);
}


if (type === TYPE.FIX_SO_DIEN_THOAI) {
	onStartFixPhoneNumber();
} else if (type === TYPE.FIX_SO_DIEN_THOAI) {
	fixKhongNhayDong();
}